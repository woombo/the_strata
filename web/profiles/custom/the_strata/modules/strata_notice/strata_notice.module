<?php

/**
 * @file
 * Primary module hooks for Strata Notice module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_ENTITY_TYPE_view_alter() for node entities.
 */
function strata_notice_node_view_alter(array &$build, NodeInterface $node, EntityViewDisplayInterface $display): void {
  // For notice nodes, embed the strata_media view for files.
  if ($node->bundle() === 'notice' && in_array($display->getMode(), ['full', 'default'])) {
    // Attach the notice CSS library.
    $build['#attached']['library'][] = 'strata_notice/notice';

    // Add wrapper class for the notice view.
    $build['#attributes']['class'][] = 'strata-notice-view';

    if ($node->hasField('field_notice_files') && !$node->get('field_notice_files')->isEmpty()) {
      $media_ids = [];
      foreach ($node->get('field_notice_files') as $item) {
        if ($item->target_id) {
          $media_ids[] = $item->target_id;
        }
      }
      if (!empty($media_ids)) {
        $build['notice_files'] = [
          '#type' => 'container',
          '#attributes' => [
            'class' => ['strata-notice-files'],
          ],
          '#weight' => 3,
          'label' => [
            '#type' => 'html_tag',
            '#tag' => 'h3',
            '#value' => t('Files'),
            '#attributes' => [
              'class' => ['strata-notice-files__label'],
            ],
          ],
          'view' => views_embed_view('strata_media', 'embed_1', implode('+', $media_ids)),
        ];
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for views_exposed_form.
 *
 * Converts the Board filter to a select dropdown on the notices view.
 */
function strata_notice_form_views_exposed_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  $view = $form_state->get('view');
  if (!$view || $view->id() !== 'strata_notices') {
    return;
  }

  // Check if the board filter exists.
  if (!isset($form['board'])) {
    return;
  }

  // Load all board nodes to populate the dropdown.
  $boards = \Drupal::entityTypeManager()
    ->getStorage('node')
    ->loadByProperties([
      'type' => 'board',
      'status' => 1,
    ]);

  // Build options array.
  $options = ['' => t('- Any -')];
  foreach ($boards as $board) {
    $options[$board->id()] = $board->label();
  }

  // Replace the text field with a select dropdown.
  $form['board'] = [
    '#type' => 'select',
    '#title' => t('Board'),
    '#options' => $options,
    '#default_value' => $form['board']['#default_value'] ?? '',
  ];
}
