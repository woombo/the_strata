<?php

/**
 * @file
 * Primary module hooks for Strata Notice module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_ENTITY_TYPE_view_alter() for node entities.
 */
function strata_notice_node_view_alter(array &$build, NodeInterface $node, EntityViewDisplayInterface $display): void {
  // For notice nodes in full/default view mode, add styling.
  // Note: File embedding is handled by strata_boards_node_view_alter() for all
  // board-enabled content types.
  if ($node->bundle() === 'notice' && in_array($display->getMode(), ['full', 'default'])) {
    // Attach the notice CSS library.
    $build['#attached']['library'][] = 'strata_notice/notice';

    // Add wrapper class for the notice view.
    $build['#attributes']['class'][] = 'strata-notice-view';

    // Hide the status badge for anonymous users.
    if (\Drupal::currentUser()->isAnonymous()) {
      // Remove status from ticket_meta if it exists (added by strata_boards).
      if (isset($build['ticket_meta']['status'])) {
        unset($build['ticket_meta']['status']);
      }
      // If ticket_meta is now empty, remove it entirely.
      if (isset($build['ticket_meta']) && count(array_filter(array_keys($build['ticket_meta']), fn($k) => !str_starts_with($k, '#'))) === 0) {
        unset($build['ticket_meta']);
      }
    }
    // Add cache context for user roles since display varies by login state.
    $build['#cache']['contexts'][] = 'user.roles:anonymous';
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for views_exposed_form.
 *
 * Converts the Board filter to a select dropdown on the notices view.
 */
function strata_notice_form_views_exposed_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  $view = $form_state->get('view');
  if (!$view || $view->id() !== 'strata_notices') {
    return;
  }

  // Check if the board filter exists.
  if (!isset($form['board'])) {
    return;
  }

  // Load all board nodes to populate the dropdown.
  $boards = \Drupal::entityTypeManager()
    ->getStorage('node')
    ->loadByProperties([
      'type' => 'board',
      'status' => 1,
    ]);

  // Build options array.
  $options = ['' => t('- Any -')];
  foreach ($boards as $board) {
    $options[$board->id()] = $board->label();
  }

  // Replace the text field with a select dropdown.
  $form['board'] = [
    '#type' => 'select',
    '#title' => t('Board'),
    '#options' => $options,
    '#default_value' => $form['board']['#default_value'] ?? '',
  ];
}
